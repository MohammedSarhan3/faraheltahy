{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة الواردات{% endblock title %}

{% block content %}
<div class="container-fluid mt-4 px-md-4">
    <h2 class="text-center mb-4 responsive-text">نظام إدارة الواردات</h2>
    <div class="row justify-content-center">
        <div class="col-12">
           
            <!-- Modal for Adding New Supply Order -->
            <div class="modal fade" id="addSupplyModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">إضافة وارد جديد</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="add_supply">
                                    
                                    <div class="mb-3">
                                        <label for="supplier_name" class="form-label">اسم المورد</label>
                                        <input type="text" class="form-control" id="supplier_name" name="supplier_name" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="date" class="form-label">التاريخ</label>
                                        <input type="date" class="form-control" id="date" name="date" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="tons" class="form-label">الكمية (طن)</label>
                                        <input type="number" step="0.001" class="form-control" id="tons" name="tons" required 
                                               pattern="[0-9]+([\.][0-9]{1,3})?" 
                                               placeholder="مثال: 5.5، 5.7">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="price_per_ton" class="form-label">سعر الطن</label>
                                        <input type="number" step="0.01" class="form-control" id="price_per_ton" name="price_per_ton" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="initial_payment" class="form-label">الدفعة الأولى</label>
                                        <input type="number" step="0.01" class="form-control"  name="initial_payment">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="initial_payment_image" class="form-label">صورة إيصال الدفعة الأولى</label>
                                        <input type="file" class="form-control" id="initial_payment_image" name="initial_payment_image" accept="image/*">
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary w-100">إضافة وارد جديد</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
        
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">قائمة الواردات</h5>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSupplyModal">
                        <i class="fas fa-plus me-1"></i>
                        إضافة وارد جديد
                    </button>
                </div>
                <div class="card-body">
                    <div class="filter-section bg-light p-3 rounded-3 mb-4 shadow-sm">
                        <form method="get" class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label for="filter_year" class="form-label fw-bold">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    السنة
                                </label>
                                <select id="filter_year" name="filter_year" class="form-select">
                                    <option value="">اختر السنة</option>
                                    {% for year in available_years %}
                                    <option value="{{ year }}" {% if request.GET.filter_year|default:current_year|stringformat:"i" == year|stringformat:"i" %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filter_month" class="form-label fw-bold">
                                    <i class="fas fa-calendar-day me-1"></i>
                                    الشهر
                                </label>
                                <select id="filter_month" name="filter_month" class="form-select">
                                    <option value="">اختر الشهر</option>
                                    <option value="01" {% if request.GET.filter_month|default:current_month == "01" %}selected{% endif %}>يناير</option>
                                    <option value="02" {% if request.GET.filter_month|default:current_month == "02" %}selected{% endif %}>فبراير</option>
                                    <option value="03" {% if request.GET.filter_month|default:current_month == "03" %}selected{% endif %}>مارس</option>
                                    <option value="04" {% if request.GET.filter_month|default:current_month == "04" %}selected{% endif %}>أبريل</option>
                                    <option value="05" {% if request.GET.filter_month|default:current_month == "05" %}selected{% endif %}>مايو</option>
                                    <option value="06" {% if request.GET.filter_month|default:current_month == "06" %}selected{% endif %}>يونيو</option>
                                    <option value="07" {% if request.GET.filter_month|default:current_month == "07" %}selected{% endif %}>يوليو</option>
                                    <option value="08" {% if request.GET.filter_month|default:current_month == "08" %}selected{% endif %}>أغسطس</option>
                                    <option value="09" {% if request.GET.filter_month|default:current_month == "09" %}selected{% endif %}>سبتمبر</option>
                                    <option value="10" {% if request.GET.filter_month|default:current_month == "10" %}selected{% endif %}>أكتوبر</option>
                                    <option value="11" {% if request.GET.filter_month|default:current_month == "11" %}selected{% endif %}>نوفمبر</option>
                                    <option value="12" {% if request.GET.filter_month|default:current_month == "12" %}selected{% endif %}>ديسمبر</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary flex-grow-1">
                                        <i class="fas fa-filter me-1"></i>
                                        تصفية
                                    </button>
                                    {% if request.GET.filter_month or request.GET.filter_year %}
                                    <a href="?" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        إلغاء
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <tbody>
                                {% for order in supply_orders %}
                                <!-- Separator between orders -->
                                {% if not forloop.first %}
                                <tr class="spacer">
                                    <td colspan="8" class="p-0"><div class="my-3"></div></td>
                                </tr>
                                {% endif %}
                                <!-- Supply order header -->
                                <tr class="table-primary">
                                    <th colspan="8" class="text-center py-3">
                                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 px-2 px-md-4">
                                            <span class="supply-number fw-bold fs-6 bg-danger text-white rounded-pill px-3 py-1 order-1 order-md-0">رقم الوارد: {{ order.number }}</span>
                                            <span class="supply-header fw-bold fs-5 text-primary order-0 order-md-1">وارد من {{ order.supplier_name }}</span>
                                            <span class="supply-month fw-bold fs-6 bg-danger text-white rounded-pill px-3 py-1 order-2">{{ order.date|date:"F"|title|default:"-" }}</span>
                                        </div>
                                    </th>
                                </tr>
                                <!-- Supply order details headers -->
                                <tr class="table-light">
                                    <th>المورد</th>
                                    <th>التاريخ</th>
                                    <th>الكمية</th>
                                    <th>سعر الطن</th>
                                    <th>الإجمالي</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>إضافة دفعة</th>
                                </tr>
                                <!-- Supply order details -->
                                <tr class="align-middle">
                                    <td class="fw-bold">{{ order.supplier_name }}</td>
                                    <td>{{ order.date }}</td>
                                    <td>{{ order.tons }}</td>
                                    <td>{{ order.price_per_ton }}</td>
                                    <td class="fw-bold">{{ order.total_amount }}</td>
                                    <td class="text-success">{{ order.paid_amount }}</td>
                                    <td class="{% if order.remaining_amount > 0 %}text-danger{% else %}text-success{% endif %} fw-bold">
                                        {{ order.remaining_amount }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="togglePaymentForm('{{ order.id }}')"
                                                    data-order-id="{{ order.id }}">
                                                <i class="fas fa-plus me-1"></i> دفعة
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editSupplyModal{{ order.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deleteSupplyModal{{ order.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Payments history for this supply order -->
                                <tr>
                                    <td colspan="8" class="p-0">
                                        <div class="collapse show payments-section" id="payments{{ order.id }}">
                                            <div class="p-3">
                                                <h6 class="text-secondary mb-3">سجل المدفوعات</h6>
                                                
                                                <!-- Inline Payment Form -->
                                                <div class="payment-form mb-4 p-4 border rounded shadow-sm bg-white" id="paymentForm{{ order.id }}" style="display: none;">
                                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                                        <h6 class="fw-bold text-primary mb-0">
                                                            <i class="fas fa-money-bill-wave me-2"></i>
                                                            إضافة دفعة جديدة
                                                        </h6>
                                                        <button type="button" class="btn-close" onclick="togglePaymentForm('{{ order.id }}')" aria-label="Close"></button>
                                                    </div>
                                                    
                                                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="add_payment">
                                                        <input type="hidden" name="supply_order_id" value="{{ order.id }}">
                                                        
                                                        <div class="row g-4">
                                                            <div class="col-md-4">
                                                                <div class="form-floating">
                                                                    <input type="number" step="0.01" class="form-control" 
                                                                           id="payment_amount{{ order.id }}"
                                                                           name="payment_amount" required
                                                                           placeholder="المبلغ">
                                                                    <label for="payment_amount{{ order.id }}">المبلغ</label>
                                                                    <div class="invalid-feedback">
                                                                        يرجى إدخال المبلغ
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="col-md-4">
                                                                <div class="form-floating">
                                                                    <input type="date" class="form-control" 
                                                                           id="payment_date{{ order.id }}"
                                                                           name="payment_date" required
                                                                           placeholder="التاريخ">
                                                                    <label for="payment_date{{ order.id }}">التاريخ</label>
                                                                    <div class="invalid-feedback">
                                                                        يرجى اختيار التاريخ
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-4">
                                                                <div class="form-floating">
                                                                    <div class="form-control" style="height: auto; min-height: 58px;" id="payment_image_wrapper{{ order.id }}">
                                                                        <div class="d-flex align-items-center gap-2">
                                                                            <i class="fas fa-file-image text-primary"></i>
                                                                            <span class="selected-file-name" id="selectedFileName{{ order.id }}">لم يتم اختيار ملف</span>
                                                                            <input type="file" class="d-none" 
                                                                                   id="payment_image{{ order.id }}"
                                                                                   name="payment_image" 
                                                                                   accept="image/*"
                                                                                   onchange="handleFileSelect(this, {{ order.id }})">
                                                                            <button type="button" class="btn btn-sm btn-link ms-auto p-0" onclick="document.getElementById('payment_image{{ order.id }}').click()">
                                                                                <i class="fas fa-upload"></i>
                                                                            </button>
                                                                        </div>
                                                                        <div id="imagePreview{{ order.id }}" class="preview-container mt-2" style="display: none;">
                                                                            <img src="" alt="معاينة" class="img-fluid rounded payment-image-preview" style="max-height: 100px;">
                                                                            <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2" 
                                                                                    onclick="removeImage('payment_image{{ order.id }}', 'imagePreview{{ order.id }}', 'selectedFileName{{ order.id }}')">
                                                                                <i class="fas fa-times"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <label for="payment_image_wrapper{{ order.id }}">صورة الشيك/التحويل</label>
                                                                    <div class="form-text small">
                                                                        <span class="text-muted">الصيغ المدعومة: JPG, PNG - الحد الأقصى: 5 ميجابايت</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="d-flex justify-content-end gap-2 mt-4">
                                                            <button type="button" class="btn btn-light" onclick="togglePaymentForm('{{ order.id }}')">
                                                                <i class="fas fa-times me-1"></i>
                                                                إلغاء
                                                            </button>
                                                            <button type="submit" class="btn btn-primary px-4">
                                                                <i class="fas fa-save me-1"></i>
                                                                حفظ الدفعة
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>

                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered mb-0">
                                                        <thead>
                                                            <tr class="table-secondary">
                                                                <th class="text-center">تاريخ الدفع</th>
                                                                <th class="text-center">المبلغ المدفوع</th>
                                                                <th class="text-center">صورة الإيصال</th>
                                                            </tr>
                                                        </thead>
                                                    <tbody>
                                                        {% for payment in order.payments.all %}
                                                        <tr>
                                                            <td class="text-center">{{ payment.date }}
                                                                <div class="btn-group float-end">
                                                                    <button type="button" class="btn btn-sm btn-link text-info p-0 mx-1" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#editPaymentModal{{ payment.id }}">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                    <button type="button" class="btn btn-sm btn-link text-danger p-0" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#deletePaymentModal{{ payment.id }}">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                            <td class="text-center text-success fw-bold">{{ payment.amount }}</td>
                                                            <td class="text-center">
                                                                {% if payment.image %}
                                                                <a href="{{ payment.image.url }}" target="_blank" class="btn btn-sm btn-link">
                                                                    <img src="{{ payment.image.url }}" alt="صورة الإيصال" class="img-fluid payment-image" style="max-height: 40px;">
                                                                </a>
                                                                {% else %}
                                                                <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% empty %}
                                                        <tr>
                                                            <td colspan="3" class="text-center text-muted">لا توجد مدفوعات بعد</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- قائمة النثريات -->
                                <tr>
                                    <td colspan="8" class="p-0">
                                        <div class="collapse show payments-section" id="expenses{{ order.id }}">
                                            <div class="p-3">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="text-secondary mb-0">النثريات</h6>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                                            onclick="toggleExpenseForm('{{ order.id }}')"
                                                            data-order-id="{{ order.id }}">
                                                        <i class="fas fa-plus me-1"></i> إضافة نثريات
                                                    </button>
                                                </div>

                                                <!-- Inline Expense Form -->
                                                <div class="payment-form mb-4 p-4 border rounded shadow-sm bg-white" id="expenseForm{{ order.id }}" style="display: none;">
                                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                                        <h6 class="fw-bold text-primary mb-0">
                                                            <i class="fas fa-money-bill-wave me-2"></i>
                                                            إضافة نثريات جديدة
                                                        </h6>
                                                        <button type="button" class="btn-close" onclick="toggleExpenseForm('{{ order.id }}')" aria-label="Close"></button>
                                                    </div>

                                                    <form method="post" class="needs-validation" novalidate>
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="add_expense">
                                                        <input type="hidden" name="supply_order_id" value="{{ order.id }}">
                                                        
                                                        <div class="row g-4">
                                                            <div class="col-md-4">
                                                                <div class="form-floating">
                                                                    <input type="number" step="0.01" class="form-control" 
                                                                           id="expense_amount{{ order.id }}"
                                                                           name="expense_amount" required
                                                                           placeholder="المبلغ">
                                                                    <label for="expense_amount{{ order.id }}">المبلغ</label>
                                                                    <div class="invalid-feedback">
                                                                        يرجى إدخال المبلغ
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-4">
                                                                <div class="form-floating">
                                                                    <input type="date" class="form-control" 
                                                                           id="expense_date{{ order.id }}"
                                                                           name="expense_date" required
                                                                           placeholder="التاريخ">
                                                                    <label for="expense_date{{ order.id }}">التاريخ</label>
                                                                    <div class="invalid-feedback">
                                                                        يرجى اختيار التاريخ
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-4">
                                                                <div class="form-floating">
                                                                    <input type="text" class="form-control" 
                                                                           id="expense_reason{{ order.id }}"
                                                                           name="expense_reason" required
                                                                           placeholder="السبب">
                                                                    <label for="expense_reason{{ order.id }}">السبب</label>
                                                                    <div class="invalid-feedback">
                                                                        يرجى إدخال السبب
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="d-flex justify-content-end gap-2 mt-4">
                                                            <button type="button" class="btn btn-light" onclick="toggleExpenseForm('{{ order.id }}')">
                                                                <i class="fas fa-times me-1"></i>
                                                                إلغاء
                                                            </button>
                                                            <button type="submit" class="btn btn-primary px-4">
                                                                <i class="fas fa-save me-1"></i>
                                                                حفظ النثريات
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>

                                                <table class="table table-sm table-bordered mb-0">
                                                    <thead>
                                                        <tr class="table-secondary">
                                                            <th class="text-center">التاريخ</th>
                                                            <th class="text-center">المبلغ</th>
                                                            <th class="text-center">السبب</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for expense in order.expenses.all %}
                                                        <tr>
                                                            <td class="text-center">{{ expense.date }}
                                                                <div class="btn-group float-end">
                                                                    <button type="button" class="btn btn-sm btn-link text-info p-0 mx-1" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#editExpenseModal{{ expense.id }}">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                    <button type="button" class="btn btn-sm btn-link text-danger p-0" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#deleteExpenseModal{{ expense.id }}">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                            <td class="text-center text-danger fw-bold">{{ expense.amount }}</td>
                                                            <td class="text-center">{{ expense.reason }}</td>
                                                        </tr>
                                                        {% empty %}
                                                        <tr>
                                                            <td colspan="3" class="text-center text-muted">لا توجد نثريات بعد</td>
                                                        </tr>
                                                        {% endfor %}
                                                        {% if order.expenses.all %}
                                                        <tr class="table-light">
                                                            <td class="text-start fw-bold">الإجمالي</td>
                                                            <td class="text-center text-danger fw-bold" colspan="2">
                                                                {{ order.total_expenses }}
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="empty-state">
                                            <i class="fas fa-box d-block mb-3 fa-3x text-muted"></i>
                                            <p class="text-muted mb-0">لا توجد واردات حتى الآن</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Supply Order Modals -->
{% for order in supply_orders %}
<div class="modal fade" id="editSupplyModal{{ order.id }}" tabindex="-1" aria-labelledby="editSupplyModalLabel{{ order.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSupplyModalLabel{{ order.id }}">تعديل الواردة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit_supply">
                    <input type="hidden" name="supply_order_id" value="{{ order.id }}">
                    
                    <div class="mb-3">
                        <label class="form-label">اسم المورد</label>
                        <input type="text" class="form-control" name="supplier_name" value="{{ order.supplier_name }}" required>
                    </div>
                    
                  
                    
                    <div class="mb-3">
                        <label class="form-label">التاريخ</label>
                        <input type="date" class="form-control" name="date" value="{{ order.date|date:'Y-m-d' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">الكمية (طن)</label>
                        <div class="input-group">
                            <span class="input-group-text border-end-0 bg-light">طن</span>
                            <input type="number" 
                                   step="0.001" 
                                   class="form-control text-start border-start-0" 
                                   name="tons" 
                                   value="{{ order.tons }}" 
                                   required
                                   pattern="[0-9]+([\.][0-9]{1,3})?"
                                   placeholder="5.5, 5.7"
                                   style="border-radius: 0 0.375rem 0.375rem 0">
                        </div>
                        <small class="text-muted mt-1 d-block text-end">يمكنك إدخال الكمية بالطن مثل: 5.5 أو 5.7</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">سعر الطن</label>
                        <input type="number" step="0.01" class="form-control" name="price_per_ton" value="{{ order.price_per_ton }}" required>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            حفظ التغييرات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Supply Modal -->
<div class="modal fade" id="deleteSupplyModal{{ order.id }}" tabindex="-1" aria-labelledby="deleteSupplyModalLabel{{ order.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteSupplyModalLabel{{ order.id }}">حذف الواردة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    هل أنت متأكد من حذف وارد <strong>{{ order.supplier_name }}</strong>؟
                    <p class="mt-2 mb-0">سيتم حذف جميع الدفعات والنثريات المرتبطة بهذا الوارد.</p>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_supply">
                    <input type="hidden" name="supply_order_id" value="{{ order.id }}">
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-1"></i>
                            تأكيد الحذف
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Payment Modals -->
{% for payment in order.payments.all %}
<div class="modal fade" id="editPaymentModal{{ payment.id }}" tabindex="-1" aria-labelledby="editPaymentModalLabel{{ payment.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPaymentModalLabel{{ payment.id }}">تعديل الدفعة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit_payment">
                    <input type="hidden" name="payment_id" value="{{ payment.id }}">
                    
                    <div class="mb-3">
                        <label class="form-label">المبلغ</label>
                        <input type="number" step="0.01" class="form-control" name="payment_amount" value="{{ payment.amount }}" >
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">التاريخ</label>
                        <input type="date" class="form-control" name="payment_date" value="{{ payment.date|date:'Y-m-d' }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">صورة الشيك/التحويل</label>
                        {% if payment.image %}
                        <div class="mb-2">
                            <img src="{{ payment.image.url }}" alt="صورة الإيصال" class="img-fluid" style="max-height: 150px;">
                        </div>
                        {% endif %}
                        <input type="file" class="form-control" name="payment_image" accept="image/*">
                        <small class="text-muted">اترك هذا الحقل فارغاً للاحتفاظ بالصورة الحالية</small>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            حفظ التغييرات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Payment Modal -->
<div class="modal fade" id="deletePaymentModal{{ payment.id }}" tabindex="-1" aria-labelledby="deletePaymentModalLabel{{ payment.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deletePaymentModalLabel{{ payment.id }}">حذف الدفعة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    هل أنت متأكد من حذف الدفعة بقيمة <strong>{{ payment.amount }}</strong> جنيه؟
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_payment">
                    <input type="hidden" name="payment_id" value="{{ payment.id }}">
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-1"></i>
                            تأكيد الحذف
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Edit Expense Modals -->
{% for expense in order.expenses.all %}
<div class="modal fade" id="editExpenseModal{{ expense.id }}" tabindex="-1" aria-labelledby="editExpenseModalLabel{{ expense.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editExpenseModalLabel{{ expense.id }}">تعديل النثريات</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit_expense">
                    <input type="hidden" name="expense_id" value="{{ expense.id }}">
                    
                    <div class="mb-3">
                        <label class="form-label">المبلغ</label>
                        <input type="number" step="0.01" class="form-control" name="expense_amount" value="{{ expense.amount }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">السبب</label>
                        <input type="text" class="form-control" name="expense_reason" value="{{ expense.reason }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">التاريخ</label>
                        <input type="date" class="form-control" name="expense_date" value="{{ expense.date|date:'Y-m-d' }}" required>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            حفظ التغييرات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Expense Modal -->
<div class="modal fade" id="deleteExpenseModal{{ expense.id }}" tabindex="-1" aria-labelledby="deleteExpenseModalLabel{{ expense.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteExpenseModalLabel{{ expense.id }}">حذف النثريات</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    هل أنت متأكد من حذف النثريات بقيمة <strong>{{ expense.amount }}</strong> جنيه لسبب: <strong>{{ expense.reason }}</strong>؟
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_expense">
                    <input type="hidden" name="expense_id" value="{{ expense.id }}">
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-1"></i>
                            تأكيد الحذف
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endfor %}
{% endblock content %}










{% block extra_css %}
<style>
    /* Responsive text sizes */
    .responsive-text {
        font-size: calc(1.2rem + 0.6vw);
    }

    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.875rem;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .payment-form {
            padding: 1rem !important;
        }
        .row.g-4 {
            gap: 1rem !important;
        }
        .col-md-4 {
            width: 100%;
        }
    }

    /* Enhanced table responsiveness */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .table-striped > tbody > tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,.02);
    }
    
    .supply-image {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    
    .supply-image:hover {
        transform: scale(1.05);
    }
    
    .supply-header {
        font-size: 1.1rem;
    }
    
    .supply-number {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .supply-month {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    /* Enhanced styles to match invoice management */
    .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        background-color: #fff;
        border-bottom: 1px solid rgba(0,0,0,.125);
    }

    @media (max-width: 576px) {
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        
        .btn-group > .btn {
            width: 100%;
            margin: 0 !important;
        }
        
        .table td, .table th {
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        
        .payment-image {
            max-height: 30px !important;
        }
        
        .payment-form .row {
            margin: -0.5rem;
        }
        
        .payment-form .col-md-4 {
            padding: 0.5rem;
        }
    }

    /* Improve scrolling on mobile */
    .table-responsive {
        scrollbar-width: thin;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Make action buttons more touch-friendly */
    @media (max-width: 768px) {
        .btn-sm {
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    }
    
    .empty-state {
        padding: 2rem;
        text-align: center;
    }
    
    .empty-state i {
        color: #dee2e6;
    }
    
    .table td, .table th {
        vertical-align: middle;
    }
    
    .modal-content {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .btn-primary {
        padding: 0.5rem 1rem;
    }
    
    .btn-primary i {
        margin-right: 0.5rem;
    }
    
    .payment-image {
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
        cursor: pointer;
    }
    
    .payment-image:hover {
        transform: scale(1.1);
    }
    
    .payment-image-preview {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
<script>
    // Toggle expense form visibility
    function toggleExpenseForm(formId) {
        const formDiv = document.getElementById('expenseForm' + formId);
        if (!formDiv) return;

        if (formDiv.style.display === 'none' || !formDiv.style.display) {
            // Hide all other expense forms first
            document.querySelectorAll('.payment-form').forEach(form => {
                form.style.display = 'none';
            });
            // Show this expense form
            formDiv.style.display = 'block';
            // Reset form when showing
            const form = formDiv.querySelector('form');
            if (form) {
                form.reset();
                // Set default date to today
                const dateInput = form.querySelector('input[type="date"]');
                if (dateInput) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            }
        } else {
            formDiv.style.display = 'none';
        }
    }

    // Make sure all functions are defined at the global scope
    function togglePaymentForm(formId) {
        const formDiv = document.getElementById('paymentForm' + formId);
        if (!formDiv) return;

        if (formDiv.style.display === 'none' || !formDiv.style.display) {
            // Hide all other payment forms first
            document.querySelectorAll('.payment-form').forEach(form => {
                form.style.display = 'none';
            });
            // Show this payment form
            formDiv.style.display = 'block';
            // Reset form when showing
            const form = formDiv.querySelector('form');
            if (form) {
                form.reset();
                const imagePreview = document.getElementById('imagePreview' + formId);
                if (imagePreview) {
                    imagePreview.style.display = 'none';
                    const previewImg = imagePreview.querySelector('img');
                    if (previewImg) previewImg.src = '';
                }
            }
        } else {
            formDiv.style.display = 'none';
        }
    }

    function formatNumberInput(input) {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(',', '.');
            e.target.value = value;
        });
    }

    function handleFileSelect(input, orderId) {
        const preview = document.getElementById('imagePreview' + orderId);
        const fileNameDisplay = document.getElementById('selectedFileName' + orderId);
        
        if (input.files && input.files[0]) {
            // Update file name display
            const fileName = input.files[0].name;
            fileNameDisplay.textContent = fileName;
            
            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = preview.querySelector('img');
                if (previewImg) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function removeImage(inputId, previewId, fileNameDisplayId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const fileNameDisplay = document.getElementById(fileNameDisplayId);
        
        if (input) input.value = '';
        if (preview) {
            preview.style.display = 'none';
            const img = preview.querySelector('img');
            if (img) img.src = '';
        }
        if (fileNameDisplay) {
            fileNameDisplay.textContent = 'لم يتم اختيار ملف';
        }
    }

    function removeImage(inputId, previewId, promptId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const prompt = document.getElementById(promptId);
        
        if (input) input.value = '';
        if (preview) {
            preview.style.display = 'none';
            const img = preview.querySelector('img');
            if (img) img.src = '';
        }
        if (prompt) prompt.style.display = 'block';
    }

    // Initialize everything when the DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize number input formatting
        document.querySelectorAll('input[type="number"]').forEach(formatNumberInput);

        // Handle payment form submissions
        document.querySelectorAll('.payment-form form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        throw new Error('Form submission failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('حدث خطأ أثناء حفظ الدفعة. يرجى المحاولة مرة أخرى.');
                });
            });
        });

        // Initialize file upload functionality
        const uploadAreas = document.querySelectorAll('.upload-area');
        uploadAreas.forEach(area => {
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.add('border-primary');
            });

            area.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.remove('border-primary');
            });

            area.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.remove('border-primary');
                const input = area.querySelector('input[type="file"]');
                if (input && e.dataTransfer.files && e.dataTransfer.files[0]) {
                    input.files = e.dataTransfer.files;
                    previewImage(input, 'imagePreview' + input.id.replace('payment_image', ''));
                }
            });
        });

        // Set default date to today for all date inputs
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(input => {
            if (!input.value) {
                input.value = today;
            }
        });
    });
</script>
{% endblock extra_js %}

